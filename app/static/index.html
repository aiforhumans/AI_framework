<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LLM Testing Interface</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="app">
    <header>
      <h1>LLM Testing Interface</h1>
    </header>
    <main>
      <nav class="tabs">
        <button class="tab-button active" data-tab="playground-tab">Playground</button>
        <button class="tab-button" data-tab="prompt-builder-tab">Prompt Builder</button>
        <button class="tab-button" data-tab="ab-tester-tab">A/B Tester</button>
        <button class="tab-button" data-tab="evaluation-tab">Evaluation</button>
        <button class="tab-button" data-tab="orchestrator-tab">Orchestrator</button>
        <button class="tab-button" data-tab="chat-lab-tab">Chat Lab</button>
        <button class="tab-button" data-tab="guardrails-tab">Guardrails</button>
        <button class="tab-button" data-tab="history-tab">History</button>
        <button class="tab-button" data-tab="dashboard-tab">Dashboard</button>
        <button class="tab-button" data-tab="tools-tab">Tools</button>
      </nav>

      <section id="playground-tab" class="tab-panel active">
        <div class="playground-header">
          <h2>Interactive Playground</h2>
          <p class="helper-text">Real-time model testing with multi-turn chat, prompt improvement, and attachment support.</p>
        </div>

        <div class="playground-layout">
          <!-- Left: Controls & System Prompt -->
          <div class="playground-sidebar">
            <div class="playground-controls">
              <h3>Configuration</h3>
              <label>
                Agent
                <select id="agent-select">
                  {% for a in agents %}
                  <option value="{{ a.id }}" data-instructions="{{ a.instructions }}">{{ a.name }}</option>
                  {% endfor %}
                </select>
              </label>
              <label>
                Model
                <select id="model-select">
                  <option value="">(From agent)</option>
                  {% for m in available_models %}
                  <option value="{{ m }}">{{ m }}</option>
                  {% endfor %}
                </select>
              </label>
              <div class="param-row">
                <label>
                  Max tokens
                  <input type="number" id="max-tokens" value="256" min="1" />
                </label>
                <label>
                  Temperature
                  <input type="number" id="temperature" value="" step="0.1" min="0" max="2" placeholder="0.7" />
                </label>
              </div>
            </div>

            <div class="system-prompt-section">
              <div class="section-header">
                <h3>System Instructions</h3>
                <button type="button" id="improve-system-btn" class="improve-btn" title="Improve with AI">‚ú® Improve</button>
              </div>
              <textarea id="agent-instructions" placeholder="Enter system instructions to guide the model's behavior..."></textarea>
              <div class="char-count"><span id="system-char-count">0</span> characters</div>
            </div>

            <div class="playground-options">
              <label class="checkbox-label">
                <input type="checkbox" id="chat-mode" checked />
                Multi-turn chat mode
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="stream-mode" checked />
                Stream responses
              </label>
              <button type="button" id="clear-chat-btn" class="secondary-btn">Clear Chat</button>
            </div>
          </div>

          <!-- Right: Chat Interface -->
          <div class="playground-chat">
            <div class="chat-messages" id="chat-messages">
              <div class="chat-welcome">
                <div class="welcome-icon">üí¨</div>
                <h3>Start a Conversation</h3>
                <p>Type a message below to begin testing. Use the ‚ú® Improve button to enhance your prompts with AI.</p>
              </div>
            </div>

            <div class="chat-input-area">
              <div class="attachments-bar" id="attachments-bar" style="display:none;">
                <div id="attachments-list"></div>
              </div>
              <div class="chat-input-container">
                <div class="input-actions-left">
                  <button type="button" id="attach-btn" class="icon-btn" title="Add attachment">üìé</button>
                  <input type="file" id="file-input" accept="image/*,.txt,.json,.md" multiple style="display:none;" />
                </div>
                <div class="prompt-input-wrapper">
                  <textarea id="prompt" placeholder="Type your message here..." rows="1"></textarea>
                  <button type="button" id="improve-prompt-btn" class="improve-btn-inline" title="Improve prompt with AI">‚ú®</button>
                </div>
                <div class="input-actions-right">
                  <button type="button" id="run-btn" class="send-btn" title="Send message">
                    <span class="send-icon">‚ñ∂</span>
                  </button>
                </div>
              </div>
              <div class="input-hints">
                <span>Press <kbd>Enter</kbd> to send, <kbd>Shift+Enter</kbd> for new line</span>
                <span id="prompt-char-count">0 chars</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Prompt Generator Modal -->
        <div id="prompt-generator-modal" class="modal" style="display:none;">
          <div class="modal-content">
            <div class="modal-header">
              <h3>‚ú® Prompt Generator</h3>
              <button type="button" class="modal-close" id="prompt-generator-close">&times;</button>
            </div>
            <div class="modal-body">
              <p class="helper-text">Describe your task or paste an existing prompt to improve. The AI will generate an optimized prompt following best practices.</p>
              <label>
                Your task or prompt to improve:
                <textarea id="prompt-generator-input" rows="6" placeholder="Example: Create a prompt that helps users write professional emails..."></textarea>
              </label>
              <div class="modal-actions">
                <button type="button" id="prompt-generator-run" class="primary-btn">Generate Improved Prompt</button>
              </div>
              <div id="prompt-generator-status" class="eval-message"></div>
              <div id="prompt-generator-result" style="display:none;">
                <h4>Generated Prompt:</h4>
                <pre id="prompt-generator-output"></pre>
                <div class="modal-actions">
                  <button type="button" id="prompt-generator-use-system" class="secondary-btn">Use as System Prompt</button>
                  <button type="button" id="prompt-generator-use-message" class="secondary-btn">Use as Message</button>
                  <button type="button" id="prompt-generator-copy" class="secondary-btn">Copy to Clipboard</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Chat Lab Tab -->
      <section id="chat-lab-tab" class="tab-panel">
        <div class="chat-lab-header">
          <h2>Multi-Turn Chat Lab</h2>
          <p class="helper-text">Explore branching conversation paths with state management. Create alternative responses and compare outcomes.</p>
        </div>

        <div class="chat-lab-layout">
          <!-- Left: Conversations List -->
          <div class="chat-lab-sidebar">
            <div class="conversations-list">
              <h3>Conversations</h3>
              <table id="chat-trees-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
              <button type="button" id="chat-tree-new-btn">New Conversation</button>
            </div>

            <div class="chat-tree-form-section">
              <h3>Conversation Settings</h3>
              <form id="chat-tree-form">
                <input type="hidden" id="chat-tree-id" />
                <label>
                  Name
                  <input type="text" id="chat-tree-name" required placeholder="My Conversation" />
                </label>
                <label>
                  Model
                  <select id="chat-tree-model">
                    {% for m in available_models %}
                    <option value="{{ m }}">{{ m }}</option>
                    {% endfor %}
                  </select>
                </label>
                <label>
                  System Prompt
                  <textarea id="chat-tree-system" rows="3" placeholder="System instructions for this conversation..."></textarea>
                </label>
                <label>
                  Description
                  <textarea id="chat-tree-description" rows="2" placeholder="Optional description..."></textarea>
                </label>
                <div class="chat-tree-form-actions">
                  <button type="submit">Save</button>
                  <button type="button" id="chat-tree-reset-btn">Reset</button>
                </div>
              </form>
              <div id="chat-tree-message" class="message"></div>
            </div>
          </div>

          <!-- Middle: Chat Interface -->
          <div class="chat-lab-main">
            <div class="chat-lab-conversation">
              <div class="chat-lab-messages" id="chat-lab-messages">
                <div class="chat-empty-state">
                  <p>Select a conversation or create a new one to start chatting.</p>
                </div>
              </div>
              
              <div class="chat-lab-input-area">
                <div class="branch-indicator" id="chat-branch-indicator" style="display:none;">
                  <span class="branch-icon">üåø</span>
                  <span id="chat-branch-info">Creating new branch...</span>
                  <button type="button" id="chat-cancel-branch-btn">Cancel</button>
                </div>
                <textarea id="chat-lab-input" rows="3" placeholder="Type your message... (Shift+Enter for newline)"></textarea>
                <div class="chat-lab-input-actions">
                  <button type="button" id="chat-lab-send-btn">Send</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Right: Tree Visualization -->
          <div class="chat-lab-tree-panel">
            <h3>Conversation Tree</h3>
            <p class="helper-text">Click a node to switch branches or create alternatives.</p>
            <div id="chat-tree-visualization" class="tree-visualization">
              <div class="tree-empty-state">No conversation loaded</div>
            </div>
            <div class="tree-controls">
              <button type="button" id="chat-refresh-tree-btn">Refresh Tree</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Guardrails Tab -->
      <section id="guardrails-tab" class="tab-panel">
        <div class="guardrails-header">
          <h2>Guardrail Tester</h2>
          <p class="helper-text">Test safety filters, PII detection, and content moderation rules.</p>
        </div>

        <div class="guardrails-layout">
          <!-- Left: Rules & Tests -->
          <div class="guardrails-sidebar">
            <!-- Rules List -->
            <div class="guardrails-rules-section">
              <div class="section-header">
                <h3>üìã Rules</h3>
                <button type="button" id="guardrail-new-rule-btn" class="small-btn">+ New</button>
              </div>
              <table id="guardrails-rules-table">
                <thead>
                  <tr>
                    <th>Enabled</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <!-- Test Cases List -->
            <div class="guardrails-tests-section">
              <div class="section-header">
                <h3>üß™ Test Cases</h3>
                <button type="button" id="guardrail-new-test-btn" class="small-btn">+ New</button>
              </div>
              <table id="guardrails-tests-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Expected</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- Center: Live Checker -->
          <div class="guardrails-checker">
            <h3>üîç Live Guardrail Check</h3>
            <div class="checker-form">
              <label>
                Input Text
                <textarea id="guardrail-check-input" rows="5" placeholder="Enter text to check against guardrails..."></textarea>
              </label>
              <button type="button" id="guardrail-check-btn">üõ°Ô∏è Check Guardrails</button>
            </div>
            <div id="guardrail-check-result" class="check-result" style="display:none;">
              <div class="result-header">
                <span id="guardrail-check-status" class="status-badge"></span>
                <span id="guardrail-check-time"></span>
              </div>
              <div class="result-flags" id="guardrail-check-flags"></div>
              <div class="result-passed" id="guardrail-check-passed"></div>
            </div>

            <hr class="section-divider" />

            <!-- Test Suite Runner -->
            <h3>üèÉ Run Test Suite</h3>
            <div class="test-runner">
              <button type="button" id="guardrail-run-all-btn">‚ñ∂ Run All Tests</button>
              <div id="guardrail-test-summary" class="test-summary" style="display:none;">
                <div class="summary-stats">
                  <span id="guardrail-test-total"></span>
                  <span id="guardrail-test-passed" class="passed"></span>
                  <span id="guardrail-test-failed" class="failed"></span>
                  <span id="guardrail-test-rate"></span>
                </div>
              </div>
              <div id="guardrail-test-results" class="test-results"></div>
            </div>
          </div>

          <!-- Right: Rule/Test Editor -->
          <div class="guardrails-editor">
            <!-- Rule Editor -->
            <div id="guardrail-rule-editor" class="editor-panel" style="display:none;">
              <h3>Edit Rule</h3>
              <form id="guardrail-rule-form">
                <input type="hidden" id="guardrail-rule-id" />
                <label>
                  Name
                  <input type="text" id="guardrail-rule-name" required />
                </label>
                <label>
                  Description
                  <textarea id="guardrail-rule-description" rows="2"></textarea>
                </label>
                <label>
                  Type
                  <select id="guardrail-rule-type">
                    <option value="pii">PII Detection</option>
                    <option value="keyword">Keyword Filter</option>
                    <option value="regex">Regex Pattern</option>
                    <option value="content">Content Moderation</option>
                  </select>
                </label>
                <label>
                  Configuration (JSON)
                  <textarea id="guardrail-rule-config" rows="6" placeholder='{"detect": ["email", "phone"]}'></textarea>
                </label>
                <label class="inline">
                  <input type="checkbox" id="guardrail-rule-enabled" checked />
                  Enabled
                </label>
                <div class="editor-actions">
                  <button type="submit">Save Rule</button>
                  <button type="button" id="guardrail-rule-cancel">Cancel</button>
                  <button type="button" id="guardrail-rule-delete" class="danger-btn">Delete</button>
                </div>
              </form>
            </div>

            <!-- Test Editor -->
            <div id="guardrail-test-editor" class="editor-panel" style="display:none;">
              <h3>Edit Test Case</h3>
              <form id="guardrail-test-form">
                <input type="hidden" id="guardrail-test-id" />
                <label>
                  Name
                  <input type="text" id="guardrail-test-name" required />
                </label>
                <label>
                  Description
                  <textarea id="guardrail-test-description" rows="2"></textarea>
                </label>
                <label>
                  Input Text
                  <textarea id="guardrail-test-input" rows="3" required></textarea>
                </label>
                <label class="inline">
                  <input type="checkbox" id="guardrail-test-blocked" />
                  Expected to be blocked
                </label>
                <label>
                  Expected Flags (comma-separated rule names)
                  <input type="text" id="guardrail-test-flags" placeholder="PII Detector, URL/Link Detector" />
                </label>
                <label>
                  Tags (comma-separated)
                  <input type="text" id="guardrail-test-tags" placeholder="pii, security" />
                </label>
                <div class="editor-actions">
                  <button type="submit">Save Test</button>
                  <button type="button" id="guardrail-test-cancel">Cancel</button>
                  <button type="button" id="guardrail-test-delete" class="danger-btn">Delete</button>
                </div>
              </form>
            </div>

            <!-- Default state message -->
            <div id="guardrail-editor-placeholder" class="editor-placeholder">
              <p>Select a rule or test case to edit, or click "+ New" to create one.</p>
            </div>
          </div>
        </div>
      </section>

      <!-- History & Replay Tab -->
      <section id="history-tab" class="tab-panel">
        <div class="history-header">
          <h2>Request History</h2>
          <p class="helper-text">Browse, search, and replay previous LLM requests.</p>
        </div>

        <div class="history-layout">
          <!-- Left: Filters & Stats -->
          <div class="history-sidebar">
            <div class="history-stats-card">
              <h3>Statistics</h3>
              <div id="history-stats">
                <div class="stat-item">
                  <span class="stat-label">Total Requests</span>
                  <span class="stat-value" id="history-stat-total">0</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Success Rate</span>
                  <span class="stat-value" id="history-stat-success">0%</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Avg Latency</span>
                  <span class="stat-value" id="history-stat-latency">0ms</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Total Tokens</span>
                  <span class="stat-value" id="history-stat-tokens">0</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Starred</span>
                  <span class="stat-value" id="history-stat-starred">0</span>
                </div>
              </div>
            </div>

            <div class="history-filters-card">
              <h3>Filters</h3>
              <label>
                Endpoint
                <select id="history-filter-endpoint">
                  <option value="">All Endpoints</option>
                </select>
              </label>
              <label>
                Model
                <select id="history-filter-model">
                  <option value="">All Models</option>
                </select>
              </label>
              <label>
                Status
                <select id="history-filter-success">
                  <option value="">All</option>
                  <option value="true">Success Only</option>
                  <option value="false">Errors Only</option>
                </select>
              </label>
              <label>
                Starred
                <select id="history-filter-starred">
                  <option value="">All</option>
                  <option value="true">Starred Only</option>
                </select>
              </label>
              <label>
                Search
                <input type="text" id="history-filter-search" placeholder="Search prompts/responses..." />
              </label>
              <div class="filter-actions">
                <button type="button" id="history-apply-filter-btn">Apply Filters</button>
                <button type="button" id="history-clear-filter-btn">Clear</button>
              </div>
            </div>

            <div class="history-actions-card">
              <h3>Actions</h3>
              <button type="button" id="history-refresh-btn">üîÑ Refresh</button>
              <button type="button" id="history-clear-btn">üóëÔ∏è Clear History</button>
            </div>
          </div>

          <!-- Main: History List -->
          <div class="history-main">
            <div class="history-list" id="history-list">
              <div class="history-empty-state">
                <p>No history entries yet. Make some LLM requests to see them here.</p>
              </div>
            </div>
            <div class="history-pagination">
              <button type="button" id="history-prev-btn" disabled>‚Üê Previous</button>
              <span id="history-page-info">Page 1</span>
              <button type="button" id="history-next-btn">Next ‚Üí</button>
            </div>
          </div>

          <!-- Right: Detail View -->
          <div class="history-detail-panel">
            <h3>Entry Details</h3>
            <div id="history-detail" class="history-detail-content">
              <p class="history-empty-state">Select an entry to view details</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Dashboard / Metrics Tab -->
      <section id="dashboard-tab" class="tab-panel">
        <div class="dashboard-header">
          <h2>Latency Dashboard</h2>
          <div class="dashboard-controls">
            <label>
              Time Range:
              <select id="dashboard-hours">
                <option value="1">Last 1 hour</option>
                <option value="6">Last 6 hours</option>
                <option value="24" selected>Last 24 hours</option>
                <option value="72">Last 3 days</option>
                <option value="168">Last 7 days</option>
              </select>
            </label>
            <button type="button" id="dashboard-refresh-btn" class="secondary-btn">üîÑ Refresh</button>
            <button type="button" id="dashboard-clear-btn" class="danger-btn">üóëÔ∏è Clear All</button>
          </div>
        </div>

        <!-- Summary Cards -->
        <div class="dashboard-summary">
          <div class="stat-card">
            <div class="stat-value" id="stat-total-requests">0</div>
            <div class="stat-label">Total Requests</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-success-rate">0%</div>
            <div class="stat-label">Success Rate</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-avg-latency">0ms</div>
            <div class="stat-label">Avg Latency</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-p95-latency">0ms</div>
            <div class="stat-label">P95 Latency</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-p99-latency">0ms</div>
            <div class="stat-label">P99 Latency</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-total-tokens">0</div>
            <div class="stat-label">Total Tokens</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-tokens-per-sec">0</div>
            <div class="stat-label">Tokens/sec</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-requests-per-min">0</div>
            <div class="stat-label">Requests/min</div>
          </div>
        </div>

        <div class="dashboard-grid">
          <!-- Hourly Trend Chart -->
          <div class="dashboard-section hourly-chart-section">
            <h3>Hourly Trend</h3>
            <div class="chart-container" id="hourly-chart-container">
              <canvas id="hourly-chart"></canvas>
            </div>
          </div>

          <!-- Model Breakdown -->
          <div class="dashboard-section model-breakdown-section">
            <h3>By Model</h3>
            <table id="model-metrics-table">
              <thead>
                <tr>
                  <th>Model</th>
                  <th>Requests</th>
                  <th>Avg Latency</th>
                  <th>Total Tokens</th>
                  <th>Success Rate</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>

          <!-- Endpoint Breakdown -->
          <div class="dashboard-section endpoint-breakdown-section">
            <h3>By Endpoint</h3>
            <table id="endpoint-metrics-table">
              <thead>
                <tr>
                  <th>Endpoint</th>
                  <th>Requests</th>
                  <th>Avg Latency</th>
                  <th>Success Rate</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>

          <!-- Recent Requests -->
          <div class="dashboard-section recent-requests-section">
            <h3>Recent Requests</h3>
            <table id="recent-requests-table">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Endpoint</th>
                  <th>Model</th>
                  <th>Latency</th>
                  <th>Tokens</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="tools-tab" class="tab-panel">
        <h2>Tools</h2>
        <div class="tools-layout">
          <div class="tools-list">
            <h3>Defined Tools</h3>
            <table id="tools-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Enabled</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>

          <div class="tool-form">
            <h3>Create / Edit Tool</h3>
            <form id="tool-form">
              <input type="hidden" id="tool-id" />
              <label>
                Name
                <input type="text" id="tool-name" required />
              </label>
              <label>
                Description
                <textarea id="tool-description" rows="3"></textarea>
              </label>
              <label>
                Endpoint
                <input type="text" id="tool-endpoint" placeholder="/api/your-tool-endpoint" />
              </label>
              <label>
                Models (comma separated)
                <input type="text" id="tool-models" placeholder="model-1, model-2" />
              </label>
              <label>
                Agents (comma separated)
                <input type="text" id="tool-agents" placeholder="agent-1, agent-2" />
              </label>
              <label>
                Input schema (JSON)
                <textarea id="tool-input-schema" rows="4" placeholder='{"type": "object", "properties": {}}'></textarea>
              </label>
              <label class="inline">
                <input type="checkbox" id="tool-enabled" checked />
                Enabled
              </label>
              <div class="tool-form-actions">
                <button type="submit">Save Tool</button>
                <button type="button" id="tool-reset-btn">Reset</button>
              </div>
              <div id="tool-form-message" class="tool-message"></div>
            </form>
          </div>
        </div>
      </section>

      <section id="ab-tester-tab" class="tab-panel">
        <h2>A/B Response Tester</h2>
        <p class="helper-text">Compare responses from different models or agents side-by-side.</p>

        <div class="ab-tester-layout">
          <div class="ab-input">
            <label>
              Prompt
              <textarea id="ab-prompt" rows="4" placeholder="Enter your test prompt..."></textarea>
            </label>
            <label>
              System prompt (optional)
              <textarea id="ab-system-prompt" rows="2" placeholder="Optional system instructions..."></textarea>
            </label>

            <div class="ab-variants">
              <h3>Variants</h3>
              <p class="helper-text">Select 2+ models or agents to compare.</p>
              <div id="ab-variants-list"></div>
              <div class="ab-add-variant">
                <select id="ab-add-variant-select">
                  <option value="">-- Add variant --</option>
                  <optgroup label="Models" id="ab-models-group">
                    {% for m in available_models %}
                    <option value="model:{{ m }}">{{ m }}</option>
                    {% endfor %}
                  </optgroup>
                  <optgroup label="Agents" id="ab-agents-group">
                    {% for a in agents %}
                    <option value="agent:{{ a.id }}">{{ a.name }}</option>
                    {% endfor %}
                  </optgroup>
                </select>
              </div>
            </div>

            <button type="button" id="ab-run-btn">Run A/B Test</button>
            <div id="ab-message" class="ab-message"></div>
          </div>

          <div class="ab-results">
            <h3>Results</h3>
            <div id="ab-results-container"></div>
          </div>
        </div>
      </section>

      <section id="evaluation-tab" class="tab-panel">
        <h2>Evaluation Suite</h2>
        <p class="helper-text">Evaluate models and agents against datasets using built-in or custom evaluators.</p>

        <div class="eval-layout">
          <!-- Left Column: Datasets & Evaluators -->
          <div class="eval-sidebar">
            <div class="eval-datasets">
              <h3>Datasets</h3>
              <table id="datasets-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Rows</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
              <button type="button" id="dataset-new-btn">New Dataset</button>
            </div>

            <div class="eval-evaluators">
              <h3>Evaluators</h3>
              <div id="evaluators-list"></div>
              <button type="button" id="evaluator-new-btn">Create Custom Evaluator</button>
            </div>
          </div>

          <!-- Middle Column: Dataset Editor / Evaluator Editor -->
          <div class="eval-editor">
            <div id="dataset-editor" class="eval-editor-section">
              <h3>Dataset Editor</h3>
              <form id="dataset-form">
                <input type="hidden" id="dataset-id" />
                <label>
                  Name
                  <input type="text" id="dataset-name" required />
                </label>
                <label>
                  Description
                  <textarea id="dataset-description" rows="2"></textarea>
                </label>
                <div class="dataset-template-section">
                  <label>
                    Load Template
                    <select id="dataset-template-select">
                      <option value="">-- Select a template --</option>
                      <option value="qa-factual">Q&A - Factual Knowledge</option>
                      <option value="qa-math">Q&A - Math Problems</option>
                      <option value="summarization">Summarization</option>
                      <option value="sentiment">Sentiment Analysis</option>
                      <option value="translation">Translation</option>
                      <option value="code-generation">Code Generation</option>
                      <option value="classification">Text Classification</option>
                      <option value="rag">RAG - Retrieval QA</option>
                    </select>
                  </label>
                </div>
                <label>
                  Rows (JSONL format: one {"query": "", "ground_truth": ""} per line)
                  <textarea id="dataset-rows" rows="8" placeholder='{"query": "What is 2+2?", "ground_truth": "4"}
{"query": "Capital of France?", "ground_truth": "Paris"}'></textarea>
                </label>
                <div class="eval-form-actions">
                  <button type="submit">Save Dataset</button>
                  <button type="button" id="dataset-reset-btn">Reset</button>
                </div>
                <div id="dataset-message" class="eval-message"></div>
              </form>

              <div class="bulk-run-section">
                <h4>Bulk Run</h4>
                <p class="helper-text">Generate responses for all queries using a model or agent.</p>
                <div class="bulk-run-controls">
                  <select id="bulk-run-model">
                    <option value="">-- Select Model --</option>
                    {% for m in available_models %}
                    <option value="{{ m }}">{{ m }}</option>
                    {% endfor %}
                  </select>
                  <select id="bulk-run-agent">
                    <option value="">-- Or Agent --</option>
                    {% for a in agents %}
                    <option value="{{ a.id }}">{{ a.name }}</option>
                    {% endfor %}
                  </select>
                  <button type="button" id="bulk-run-btn">Run Bulk Generate</button>
                </div>
                <div id="bulk-run-message" class="eval-message"></div>
                <div id="bulk-run-progress" class="bulk-run-progress" style="display:none;">
                  <div class="progress-bar-container">
                    <div id="bulk-run-progress-bar" class="progress-bar"></div>
                  </div>
                  <div id="bulk-run-progress-text"></div>
                </div>
                <div id="bulk-run-live" class="bulk-run-live" style="display:none;">
                  <h5>Live Responses</h5>
                  <div id="bulk-run-live-list"></div>
                </div>
              </div>
            </div>

            <div id="evaluator-editor" class="eval-editor-section" style="display:none;">
              <h3>Custom Evaluator Editor</h3>
              <form id="evaluator-form">
                <input type="hidden" id="evaluator-id" />
                <label>
                  Name
                  <input type="text" id="evaluator-name" required />
                </label>
                <label>
                  Description
                  <textarea id="evaluator-description" rows="2"></textarea>
                </label>
                <label>
                  Type
                  <select id="evaluator-type">
                    <option value="llm">LLM-based</option>
                    <option value="code">Code-based (Python)</option>
                  </select>
                </label>
                <div id="evaluator-llm-section">
                  <label>
                    LLM Prompt
                    <textarea id="evaluator-llm-prompt" rows="6" placeholder='Evaluate the response: "{{response}}" against the expected: "{{ground_truth}}". Return JSON: {"score": 0-1, "reason": "..."}'></textarea>
                  </label>
                </div>
                <div id="evaluator-code-section" style="display:none;">
                  <label>
                    Python Code
                    <textarea id="evaluator-code" rows="8" placeholder='def evaluate(query, response, ground_truth, **kwargs):
    # Your evaluation logic
    score = 1.0 if response.strip() == ground_truth.strip() else 0.0
    return {"score": score, "reason": "Exact match check"}'></textarea>
                  </label>
                </div>
                <div class="eval-form-actions">
                  <button type="submit">Save Evaluator</button>
                  <button type="button" id="evaluator-cancel-btn">Cancel</button>
                </div>
                <div id="evaluator-message" class="eval-message"></div>
              </form>
            </div>
          </div>

          <!-- Right Column: Evaluation Jobs -->
          <div class="eval-jobs">
            <h3>Evaluation Jobs</h3>
            <div class="new-eval-job">
              <h4>New Evaluation</h4>
              <label>
                Job Name
                <input type="text" id="eval-job-name" placeholder="My Evaluation" />
              </label>
              <label>
                Dataset
                <select id="eval-job-dataset"></select>
              </label>
              <label>
                Evaluators (select multiple)
                <select id="eval-job-evaluators" multiple size="5"></select>
              </label>
              <button type="button" id="eval-job-create-btn">Create & Run Evaluation</button>
              <div id="eval-job-message" class="eval-message"></div>
            </div>

            <div class="eval-job-history">
              <h4>Job History</h4>
              <div id="eval-jobs-list"></div>
            </div>

            <div id="eval-results-view" style="display:none;">
              <h4>Results: <span id="eval-results-title"></span></h4>
              <div id="eval-aggregate-scores"></div>
              <table id="eval-results-table">
                <thead>
                  <tr>
                    <th>Row</th>
                    <th>Evaluator</th>
                    <th>Score</th>
                    <th>Reason</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
              <button type="button" id="eval-results-close-btn">Close</button>
            </div>
          </div>
        </div>
      </section>

      <section id="prompt-builder-tab" class="tab-panel">
        <h2>Prompt Builder</h2>
        <div class="prompt-builder-layout">
          <!-- Preset Templates Section -->
          <div class="prompt-presets-section">
            <h3>Preset Templates</h3>
            <p class="helper-text">Quick-start with professionally designed prompt patterns</p>
            <div class="preset-category-tabs">
              <button type="button" class="preset-cat-btn active" data-category="all">All</button>
              <button type="button" class="preset-cat-btn" data-category="roleplay">üé≠ Role-Play</button>
              <button type="button" class="preset-cat-btn" data-category="cot">üß† Chain-of-Thought</button>
              <button type="button" class="preset-cat-btn" data-category="fewshot">üìö Few-Shot</button>
              <button type="button" class="preset-cat-btn" data-category="general">‚öôÔ∏è General</button>
            </div>
            <div id="preset-templates-grid" class="preset-templates-grid"></div>
          </div>

          <div class="prompt-templates">
            <h3>My Templates</h3>
            <div class="template-filter-row">
              <select id="template-category-filter">
                <option value="">All Categories</option>
                <option value="roleplay">üé≠ Role-Play</option>
                <option value="cot">üß† Chain-of-Thought</option>
                <option value="fewshot">üìö Few-Shot</option>
                <option value="general">‚öôÔ∏è General</option>
                <option value="custom">üìù Custom</option>
              </select>
            </div>
            <table id="prompt-templates-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <button type="button" id="prompt-template-new-btn">New Template</button>
          </div>

          <div class="prompt-template-editor">
            <h3>Create / Edit Template</h3>
            <form id="prompt-template-form">
              <input type="hidden" id="prompt-template-id" />
              <label>
                Name
                <input type="text" id="prompt-template-name" required />
              </label>
              <label>
                Category
                <select id="prompt-template-category">
                  <option value="custom">üìù Custom</option>
                  <option value="roleplay">üé≠ Role-Play</option>
                  <option value="cot">üß† Chain-of-Thought</option>
                  <option value="fewshot">üìö Few-Shot</option>
                  <option value="general">‚öôÔ∏è General</option>
                </select>
              </label>
              <label>
                Description
                <textarea id="prompt-template-description" rows="2"></textarea>
              </label>
              <label>
                System prompt
                <textarea id="prompt-template-system" rows="3" placeholder="System-level instructions..."></textarea>
              </label>
              <label>
                User prompt
                <textarea id="prompt-template-user" rows="4" placeholder="User prompt, you can use {{variable}} placeholders"></textarea>
              </label>
              <label>
                Variables (comma separated)
                <input type="text" id="prompt-template-variables" placeholder="name, topic, tone" />
              </label>
              <div class="prompt-template-actions">
                <button type="submit">Save Template</button>
                <button type="button" id="prompt-template-reset-btn">Reset</button>
              </div>
              <div id="prompt-template-message" class="prompt-message"></div>
            </form>

            <h3>Preview & Run</h3>
            <div class="prompt-preview">
              <label>
                Variable values (JSON)
                <textarea id="prompt-template-vars-json" rows="4" placeholder='{"name": "Alex", "topic": "fractions"}'></textarea>
              </label>
              <button type="button" id="prompt-template-apply-btn">Apply to Playground</button>
              <pre id="prompt-template-preview"></pre>
            </div>
          </div>
        </div>
      </section>

      <section id="orchestrator-tab" class="tab-panel">
        <h2>Agent Orchestrator</h2>
        <p class="helper-text">Design and run multi-step agent workflows with conditional logic and tool integration.</p>

        <div class="orchestrator-layout">
          <!-- Left: Workflows List -->
          <div class="orchestrator-sidebar">
            <div class="workflows-list">
              <h3>Workflows</h3>
              <table id="workflows-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Nodes</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
              <button type="button" id="workflow-new-btn">New Workflow</button>
            </div>

            <div class="workflow-runs-list">
              <h3>Run History</h3>
              <div id="workflow-runs-container"></div>
            </div>
          </div>

          <!-- Middle: Workflow Editor -->
          <div class="orchestrator-editor">
            <div class="workflow-form-section">
              <h3>Workflow Editor</h3>
              <form id="workflow-form">
                <input type="hidden" id="workflow-id" />
                <div class="workflow-header-row">
                  <label>
                    Name
                    <input type="text" id="workflow-name" required placeholder="My Workflow" />
                  </label>
                  <label>
                    Description
                    <input type="text" id="workflow-description" placeholder="Optional description" />
                  </label>
                </div>
              </form>
            </div>

            <!-- Visual Canvas -->
            <div class="workflow-canvas-section">
              <div class="canvas-toolbar">
                <span class="toolbar-label">Add Node:</span>
                <button type="button" class="node-add-btn" data-type="start" title="Start Node">‚ñ∂ Start</button>
                <button type="button" class="node-add-btn" data-type="agent" title="Agent Node">ü§ñ Agent</button>
                <button type="button" class="node-add-btn" data-type="tool" title="Tool Node">üîß Tool</button>
                <button type="button" class="node-add-btn" data-type="condition" title="Condition Node">‚ùì Condition</button>
                <button type="button" class="node-add-btn" data-type="end" title="End Node">‚èπ End</button>
                <span class="toolbar-separator"></span>
                <button type="button" id="workflow-clear-canvas" class="toolbar-btn-danger" title="Clear All">üóë Clear</button>
              </div>
              <div class="workflow-canvas" id="workflow-canvas">
                <div class="canvas-placeholder">
                  <p>Click buttons above to add nodes. Drag nodes to position them. Click nodes to configure.</p>
                </div>
              </div>
            </div>

            <div class="workflow-actions">
              <button type="button" id="workflow-save-btn">üíæ Save Workflow</button>
              <button type="button" id="workflow-reset-btn" class="secondary-btn">Reset</button>
            </div>
            <div id="workflow-message" class="eval-message"></div>
          </div>

          <!-- Right: Node Editor & Run Panel -->
          <div class="orchestrator-config">
            <div class="node-editor" id="node-editor" style="display:none;">
              <h3>Node Configuration</h3>
              <form id="node-config-form">
                <input type="hidden" id="node-config-id" />
                <label>
                  Node Label
                  <input type="text" id="node-config-label" required />
                </label>
                <div id="node-config-type-fields"></div>
                <h4>Connections</h4>
                <div class="node-connections">
                  <label>
                    Connect to:
                    <select id="node-connect-target">
                      <option value="">-- Select target node --</option>
                    </select>
                  </label>
                  <div id="node-connect-condition-wrap" style="display:none;">
                    <label>
                      Condition (for conditional edges)
                      <input type="text" id="node-connect-condition" placeholder="contains:yes OR equals:approved" />
                    </label>
                  </div>
                  <button type="button" id="node-add-edge-btn">Add Connection</button>
                </div>
                <div class="node-current-edges">
                  <h5>Current Edges:</h5>
                  <ul id="node-edges-list"></ul>
                </div>
                <div class="node-editor-actions">
                  <button type="button" id="node-save-btn">Update Node</button>
                  <button type="button" id="node-delete-btn" class="danger-btn">Delete Node</button>
                </div>
              </form>
            </div>

            <div class="workflow-run-section">
              <h3>Run Workflow</h3>
              <label>
                Input Data (JSON)
                <textarea id="workflow-run-input" rows="4" placeholder='{"query": "What is the capital of France?"}'></textarea>
              </label>
              <button type="button" id="workflow-run-btn">‚ñ∂ Execute Workflow</button>
              <div id="workflow-run-message" class="eval-message"></div>
            </div>

            <div class="workflow-execution-view" id="workflow-execution-view" style="display:none;">
              <h3>Execution Result</h3>
              <div class="execution-summary">
                <span id="execution-status"></span>
                <span id="execution-duration"></span>
              </div>
              <div class="execution-steps" id="execution-steps"></div>
              <div class="execution-final">
                <h4>Final Output:</h4>
                <pre id="execution-output"></pre>
              </div>
              <button type="button" id="execution-close-btn" class="secondary-btn">Close</button>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script src="/static/main.js?v=5"></script>
</body>
</html>
